# Entity Management Features

This document describes the SQL functions used to add and retrieve entities in the Percolate graph, including user-scoped access control.

## 1. Adding Nodes to the Graph

### 1.1 Function: p8.add_nodes(table_name TEXT)
- Batch-merges new entities into the AGE graph from a view `p8.vw_<schema>_<table>`.  
- Processes up to 1660 rows per call where `gid IS NULL` (i.e. not yet added).  
- Constructs a single Cypher `CREATE` statement to merge all nodes with properties:
  - `uid`: primary key from source table
  - `key`: business key (string identifier)
  - `user_id`: owner ID (nullable; `NULL` → public entity)
- Returns the number of nodes created in this batch.

### 1.2 Function: p8.insert_entity_nodes(entity_table TEXT)
- Wraps `p8.add_nodes` in a loop until no more rows remain to be added.  
- Accumulates `total_records_affected` across iterations.  
- Returns a table `(entity_name TEXT, total_records_affected INT)`.

## 2. Retrieving Entities from the Graph

### 2.1 Function: p8.get_graph_nodes_by_key(keys TEXT[], userid TEXT DEFAULT NULL)
Retrieves graph nodes by their business key, with basic access control:
- When `userid` is NULL (default), only nodes where `v.user_id IS NULL` (public) are returned.
- When `userid` is provided, nodes where `v.user_id IS NULL` (public) or `v.user_id = userid` (owned by that user) are returned.
Returns a table `(id TEXT, entity_type TEXT)` where:
  - `id` is the graph UID (`v.uid`),  
  - `entity_type` is the node label (converted from `v::json->>'label'`).

### 2.2 Function: p8.get_entities(keys TEXT[], userid TEXT DEFAULT NULL)
- High-level wrapper that:
  1. Calls `p8.get_graph_nodes_by_key(keys, userid)` to fetch matching node IDs and types, applying access control.
  2. Groups results by `entity_type` and aggregates `id` values into arrays.
  3. Joins each group back to the underlying SQL table via `p8.get_records_by_keys(entity_type, keys)` to fetch full records.
  4. Returns a JSONB object mapping each `entity_type` (e.g. `p8.Agent`) to an array of table rows.
Example Usage:
```sql
-- Only public entities (no user context):
SELECT * FROM p8.get_entities(ARRAY['p8.Agent']);

-- Public and user-specific entities (user 'user123'):
SELECT * FROM p8.get_entities(ARRAY['p8.Agent'], 'user123');
```

## 3. Naming Conventions
- SQL functions use parameter `userid` (no underscore) to match typical PostgreSQL naming.  
- Graph node property is `user_id` (with underscore) and stored as a string in the AGE graph.  
- Access control logic bridges the two: `userid` → `v.user_id`.

---
_*This file was autogenerated as part of the SQL entity management review._